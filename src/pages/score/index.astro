---
export const prerender = false;
import Base from '../../layouts/Base.astro';
import { getTopLifeScores } from '../../lib/db';
import { DIMENSION_LABELS, DIMENSION_WEIGHTS, gradeBgClass } from '../../lib/scores';

const db = Astro.locals.runtime.env.DB;
const [topMetros, topStates] = await Promise.all([
  getTopLifeScores(db, 'metro', 20),
  getTopLifeScores(db, 'state', 10),
]);

const dimensions = Object.entries(DIMENSION_LABELS);
const weights = Object.entries(DIMENSION_WEIGHTS);
---

<Base
  title="Life Score — Quality of Life Rankings"
  description="Compare metros and states with our composite Life Score rating. Cost of living, wages, rent, safety, schools, childcare, and environment — all in one score."
  breadcrumbs={[
    { name: 'Home', href: '/' },
    { name: 'Life Score' },
  ]}
>
  <div class="max-w-6xl mx-auto px-4 py-10">
    <div class="mb-10">
      <h1 class="text-3xl font-bold text-[var(--color-text)] mb-3">Life Score Rankings</h1>
      <p class="text-lg text-[var(--color-text-secondary)] max-w-3xl">
        Our composite quality-of-life rating combines 7 data dimensions into a single score.
        Each metro and state gets a percentile-based grade from A+ to F based on cost of living,
        wages, rent, safety, schools, childcare costs, and environmental quality.
      </p>
    </div>

    <!-- Methodology -->
    <section class="mb-12 p-6 rounded-xl border border-[var(--color-border)] bg-[var(--color-surface)]">
      <h2 class="text-xl font-semibold text-[var(--color-text)] mb-4">How It Works</h2>
      <p class="text-sm text-[var(--color-text-secondary)] mb-4">
        Each dimension is scored on a 0-100 percentile scale across all metros (or states).
        For dimensions where lower is better (cost, rent, crime, childcare), the score is inverted
        so that 100 always means "best." The weighted composite determines the final grade.
      </p>
      <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-3">
        {weights.map(([key, weight]) => (
          <div class="text-center p-3 rounded-lg bg-[var(--color-bg)]">
            <div class="text-sm font-medium text-[var(--color-text)]">{DIMENSION_LABELS[key as keyof typeof DIMENSION_LABELS]}</div>
            <div class="text-lg font-bold text-[var(--color-primary)]">{Math.round(weight * 100)}%</div>
          </div>
        ))}
      </div>
      <p class="text-xs text-[var(--color-text-secondary)] mt-3">
        Grade scale: A+ (95+), A (90-94), A- (85-89), B+ (80-84), B (75-79), B- (70-74),
        C+ (65-69), C (60-64), C- (55-59), D (45-54), F (&lt;45).
      </p>
    </section>

    <!-- Top Metros -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-[var(--color-text)]">Top 20 Metros</h2>
        <a href="/score/rankings" class="text-sm font-medium text-[var(--color-primary)] hover:underline">View all rankings &rarr;</a>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-[var(--color-border)]">
              <th class="py-2 pr-3 text-left font-medium text-[var(--color-text-secondary)]">#</th>
              <th class="py-2 pr-3 text-left font-medium text-[var(--color-text-secondary)]">Metro</th>
              <th class="py-2 pr-3 text-center font-medium text-[var(--color-text-secondary)]">Grade</th>
              <th class="py-2 pr-3 text-right font-medium text-[var(--color-text-secondary)]">Score</th>
              {dimensions.map(([, label]) => (
                <th class="py-2 pr-3 text-right font-medium text-[var(--color-text-secondary)] hidden lg:table-cell">{label}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {topMetros.map((s, i) => (
              <tr class="border-b border-[var(--color-border)] hover:bg-[var(--color-surface)]">
                <td class="py-2.5 pr-3 text-[var(--color-text-secondary)]">{i + 1}</td>
                <td class="py-2.5 pr-3">
                  <a href={`/score/${s.slug}`} class="font-medium text-[var(--color-text)] hover:text-[var(--color-primary)]">{s.name}</a>
                </td>
                <td class="py-2.5 pr-3 text-center">
                  <span class={`inline-block px-2 py-0.5 rounded-md text-xs font-bold ${gradeBgClass(s.grade)}`}>{s.grade}</span>
                </td>
                <td class="py-2.5 pr-3 text-right font-medium text-[var(--color-text)]">{s.composite_score.toFixed(1)}</td>
                {['cost_score','wages_score','rent_score','crime_score','schools_score','childcare_score','enviro_score'].map(key => (
                  <td class="py-2.5 pr-3 text-right text-[var(--color-text-secondary)] hidden lg:table-cell">
                    {s[key as keyof typeof s] !== null ? (s[key as keyof typeof s] as number).toFixed(0) : '—'}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Top States -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-[var(--color-text)]">Top 10 States</h2>
        <a href="/score/rankings?type=state" class="text-sm font-medium text-[var(--color-primary)] hover:underline">View all states &rarr;</a>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-[var(--color-border)]">
              <th class="py-2 pr-3 text-left font-medium text-[var(--color-text-secondary)]">#</th>
              <th class="py-2 pr-3 text-left font-medium text-[var(--color-text-secondary)]">State</th>
              <th class="py-2 pr-3 text-center font-medium text-[var(--color-text-secondary)]">Grade</th>
              <th class="py-2 pr-3 text-right font-medium text-[var(--color-text-secondary)]">Score</th>
              {dimensions.map(([, label]) => (
                <th class="py-2 pr-3 text-right font-medium text-[var(--color-text-secondary)] hidden lg:table-cell">{label}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {topStates.map((s, i) => (
              <tr class="border-b border-[var(--color-border)] hover:bg-[var(--color-surface)]">
                <td class="py-2.5 pr-3 text-[var(--color-text-secondary)]">{i + 1}</td>
                <td class="py-2.5 pr-3">
                  <a href={`/score/states/${s.slug}`} class="font-medium text-[var(--color-text)] hover:text-[var(--color-primary)]">{s.name}</a>
                </td>
                <td class="py-2.5 pr-3 text-center">
                  <span class={`inline-block px-2 py-0.5 rounded-md text-xs font-bold ${gradeBgClass(s.grade)}`}>{s.grade}</span>
                </td>
                <td class="py-2.5 pr-3 text-right font-medium text-[var(--color-text)]">{s.composite_score.toFixed(1)}</td>
                {['cost_score','wages_score','rent_score','crime_score','schools_score','childcare_score','enviro_score'].map(key => (
                  <td class="py-2.5 pr-3 text-right text-[var(--color-text-secondary)] hidden lg:table-cell">
                    {s[key as keyof typeof s] !== null ? (s[key as keyof typeof s] as number).toFixed(0) : '—'}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Data Sources -->
    <section class="p-6 rounded-xl border border-[var(--color-border)] bg-[var(--color-surface)]">
      <h2 class="text-lg font-semibold text-[var(--color-text)] mb-3">Data Sources</h2>
      <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-[var(--color-text-secondary)]">
        <li><strong>Cost of Living:</strong> BEA Regional Price Parities</li>
        <li><strong>Wages:</strong> BLS Occupational Employment Statistics</li>
        <li><strong>Rent:</strong> HUD Fair Market Rents</li>
        <li><strong>Safety:</strong> FBI Crime Data Explorer</li>
        <li><strong>Schools:</strong> NCES Common Core of Data</li>
        <li><strong>Childcare:</strong> DOL National Database of Childcare Prices</li>
        <li><strong>Environment:</strong> EPA ECHO Enforcement Data</li>
      </ul>
    </section>
  </div>
</Base>
