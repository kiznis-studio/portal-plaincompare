---
export const prerender = false;
import Base from '../../layouts/Base.astro';
import { getAllLifeScoreRankings } from '../../lib/db';
import { DIMENSION_LABELS, gradeBgClass } from '../../lib/scores';

const db = Astro.locals.runtime.env.DB;
const type = Astro.url.searchParams.get('type') === 'state' ? 'state' : 'metro';
const rankings = await getAllLifeScoreRankings(db, type);

const dimensions = Object.entries(DIMENSION_LABELS);
const isState = type === 'state';
const title = isState ? 'State Life Score Rankings' : 'Metro Life Score Rankings';
const desc = isState
  ? 'All 51 U.S. states ranked by composite Life Score — quality of life across cost, wages, rent, safety, schools, childcare, and environment.'
  : 'All 387 U.S. metros ranked by composite Life Score — quality of life across cost, wages, rent, safety, schools, childcare, and environment.';
---

<Base
  title={`${title} — Best Places to Live`}
  description={desc}
  breadcrumbs={[
    { name: 'Home', href: '/' },
    { name: 'Life Score', href: '/score/' },
    { name: 'Rankings' },
  ]}
>
  <div class="max-w-6xl mx-auto px-4 py-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-[var(--color-text)] mb-2">{title}</h1>
        <p class="text-[var(--color-text-secondary)]">{rankings.length} {isState ? 'states' : 'metros'} ranked by composite quality-of-life score</p>
      </div>
      <div class="flex gap-2">
        <a href="/score/rankings" class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${!isState ? 'bg-[var(--color-primary)] text-white' : 'border border-[var(--color-border)] text-[var(--color-text-secondary)] hover:bg-[var(--color-surface)]'}`}>Metros</a>
        <a href="/score/rankings?type=state" class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${isState ? 'bg-[var(--color-primary)] text-white' : 'border border-[var(--color-border)] text-[var(--color-text-secondary)] hover:bg-[var(--color-surface)]'}`}>States</a>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="rankings-table">
        <thead class="sticky top-14 bg-[var(--color-bg)] z-10">
          <tr class="border-b border-[var(--color-border)]">
            <th class="py-2 pr-3 text-left font-medium text-[var(--color-text-secondary)]">#</th>
            <th class="py-2 pr-3 text-left font-medium text-[var(--color-text-secondary)]">{isState ? 'State' : 'Metro'}</th>
            <th class="py-2 pr-3 text-center font-medium text-[var(--color-text-secondary)]">Grade</th>
            <th class="py-2 pr-3 text-right font-medium text-[var(--color-text-secondary)] cursor-pointer hover:text-[var(--color-primary)]" data-sort="composite">Score</th>
            {dimensions.map(([key, label]) => (
              <th class="py-2 pr-3 text-right font-medium text-[var(--color-text-secondary)] hidden md:table-cell cursor-pointer hover:text-[var(--color-primary)]" data-sort={key}>{label}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rankings.map((s, i) => (
            <tr class="border-b border-[var(--color-border)] hover:bg-[var(--color-surface)]">
              <td class="py-2.5 pr-3 text-[var(--color-text-secondary)]">{i + 1}</td>
              <td class="py-2.5 pr-3">
                <a href={isState ? `/score/states/${s.slug}` : `/score/${s.slug}`} class="font-medium text-[var(--color-text)] hover:text-[var(--color-primary)]">{s.name}</a>
              </td>
              <td class="py-2.5 pr-3 text-center">
                <span class={`inline-block px-2 py-0.5 rounded-md text-xs font-bold ${gradeBgClass(s.grade)}`}>{s.grade}</span>
              </td>
              <td class="py-2.5 pr-3 text-right font-medium text-[var(--color-text)]">{s.composite_score.toFixed(1)}</td>
              {['cost_score','wages_score','rent_score','crime_score','schools_score','childcare_score','enviro_score'].map(key => (
                <td class="py-2.5 pr-3 text-right text-[var(--color-text-secondary)] hidden md:table-cell">
                  {s[key as keyof typeof s] !== null ? (s[key as keyof typeof s] as number).toFixed(0) : '—'}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</Base>
